<link rel="import" href="../../polymer/polymer-element.html">
<link rel="import" href="../../paper-styles/typography.html">
<link rel="import" href="../../paper-item/paper-icon-item.html">
<link rel="import" href="../../paper-item/paper-item-body.html">
<link rel="import" href="../../iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../iron-image/iron-image.html">
<link rel="import" href="../../from-now/from-now.html">
<link rel="import" href="../../polymer/lib/mixins/gesture-event-listeners.html">
<link rel="import" href="../icons.html">

<dom-module id="skeleton-chat-message">
  <template>
    <!--suppress CssInvalidPseudoSelector -->
    <!--suppress CssUnresolvedCustomProperty -->
    <!--suppress CssUnresolvedCustomPropertySet -->
    <style is="custom-style">
      :host {
        display: block;
        box-sizing: border-box;
        max-width: 100%;
        width: 100%;
        padding-bottom: 0.5rem;
        --skeleton-chat-message: {
        };
        @apply --skeleton-chat-message;

        /* Default mixin */
        --skeleton-chat-message-height: 32px;
        min-height: var(--skeleton-chat-message-height);
        --skeleton-chat-message-icon-color: var(--paper-grey-100);
        --skeleton-chat-message-icon-acronym: {
          background-color: var(--paper-grey-400);
        };
        /* Font styles */
        --skeleton-chat-message-font-family: 'Roboto', 'Noto', sans-serif;
        --skeleton-chat-message-font-size: 15px;
        --skeleton-chat-message-font-weight: 400;
        --skeleton-chat-message-font-color: white;
        --skeleton-chat-message-font-color-dark: var(--paper-grey-200);

        /* theme colors */
        --skeleton-chat-bubble-color: var(--paper-blue-500);
        --skeleton-chat-bubble-color-dark: var(--paper-blue-700);
      }

      :host([theme="dark"]) {
        --skeleton-chat-bubble-color: var(--skeleton-chat-bubble-color-dark);
        --skeleton-chat-message-font-color: var(--skeleton-chat-message-font-color-dark);
      }

      :host,
      :host > * {
        -webkit-tap-highlight-color: rgba(0, 0, 0, 0);
      }

      paper-icon-item {
        box-sizing: border-box;
        margin-bottom: 0.5rem;
        --paper-item-focused-before: {
          background-color: transparent;
        };
        --paper-item-selected: {
          background-color: transparent;
        };
        --paper-item-focused: {
          background-color: transparent;
        };
        --paper-icon-item: {
          @apply --layout-start;
        };
        --paper-item-icon-width: calc(var(--skeleton-chat-message-height) * 1.5);
        --paper-item-min-height: var(--skeleton-chat-message-height);
      }

      .icon-container {
        background-color: var(--skeleton-chat-message-icon-color);
        width: var(--skeleton-chat-message-height);
        height: var(--skeleton-chat-message-height);
        border-radius: 50%;
        overflow: hidden;
        position: relative;
      }

      [owner] .icon-container {
        background-color: transparent !important;
      }

      iron-image {
        width: var(--skeleton-chat-message-height);
        height: var(--skeleton-chat-message-height);
        border-radius: 50%;
        overflow: hidden;
        @apply --layout-fit;
        z-index: 2;
      }

      /*paper-icon-item {
        display: block;
        width: 100%;
        min-height: var(--skeleton-chat-message-height);
      }*/
      #bubble-container {
        @apply --layout-flex-auto;
        position: relative;
        display: block;
        max-width: calc(100% - var(--paper-item-icon-width));
      }

      .bubble {
        box-sizing: border-box;
        min-height: var(--skeleton-chat-message-height);
        background-color: var(--skeleton-chat-bubble-color);
        border-radius: calc(var(--skeleton-chat-message-height) / 2);
        color: white;
        display: inline-block;
        max-width: 100%;
        width: auto;
        transition: max-width ease 0.5s;
      }

      .bubble-content {
        position: relative;
        max-width: 100%;
      }

      .bubble-text {
        max-width: 100%;
        color: var(--skeleton-chat-message-font-color);
      }

      [owner] .bubble-text {
        color: var(--paper-grey-900);
      }

      [owner] #bubble-container {
        text-align: right;
      }

      .bubble-text > * {
        display: inline-block;
        word-wrap: break-word;
        box-sizing: border-box;
        max-width: 100%;
        -webkit-font-smoothing: antialiased;
        line-height: calc(var(--skeleton-chat-message-font-size) * 1.4);
        font-size: var(--skeleton-chat-message-font-size);
        font-weight: var(--skeleton-chat-message-font-weight);
        padding: calc(calc(var(--skeleton-chat-message-height) - var(--skeleton-chat-message-font-size)) / 2) calc(var(--skeleton-chat-message-height) / 2);
      }

      .time {
        padding-top: 3px;
        @apply --paper-font-caption;
        color: var(--paper-grey-500);
        @apply --layout-flex-none;
      }

      [owner] paper-icon-item {
        text-align: right;
      }

      [owner] iron-image {
        display: none !important;
      }

      [owner] .bubble {
        background-color: var(--paper-grey-100);
      }

      [hidden] {
        display: none;
      }

      [owner] .text-original[hidden] {
        display: block !important;
      }

      [owner] .text-translation {
        display: none !important;
      }

      .icon-option {
        padding: 3px;
      }

      #acronym {
        @apply --paper-font-subhead;
        @apply --paper-font-common-nowrap;
        line-height: var(--skeleton-chat-message-height);
        text-transform: uppercase;
        text-align: center;
        @apply --layout-fit;
        z-index: 1;
        @apply --skeleton-chat-message-icon-acronym;
      }
    </style>

    <paper-icon-item owner$="[[isOwner]]">
      <div class="icon-container" slot="item-icon">
        <template is="dom-if" if="[[!isOwner]]">
            <iron-image fade
                        sizing="cover"
                        src$="[[image]]"
                        hidden$="[[!image]]"></iron-image>

            <div id="acronym" hidden$="[[!acronym]]">
              [[acronym]]
            </div>

            <iron-icon icon$="chat-icon:[[icon]]"
                       class="icon-option"
                       hidden$="[[!icon]]"></iron-icon>
        </template>
      </div>
      <div id="bubble-container">
        <div class="bubble" on-down="_bubbleDown" on-up="_bubbleUp">
          <div class="bubble-content">
            <template is="dom-if" if="[[originalText]]">
              <div class="bubble-text">
                <div class="text-original" hidden$="[[!showOriginal]]">[[originalText]]</div>
                <div class="text-translation" hidden$="[[showOriginal]]">[[text]]</div>
              </div>
            </template>
          </div>
        </div>
        <div class="time" hidden$="[[!time]]" secondary>
          <from-now time="[[time]]"></from-now>
        </div>
      </div>
    </paper-icon-item>
  </template>

  <script>
    /* eslint-disable max-len */

    /**
     * `skeleton-chat-message`
     *
     *
     * @license Copyright (c) 2018 FabricElements. All rights reserved.
     * @customElement
     * @polymer
     * @demo demo/index.html
     */
    class SkeletonChatMessage extends Polymer.GestureEventListeners(Polymer.Element) {
      /**
       * @return {string}
       */
      static get is() {
        return 'skeleton-chat-message';
      }

      /**
       * @return {object}
       */
      static get properties() {
        return {
          /**
           * A value to check if the user is signed in.
           */
          signedIn: {
            type: Boolean,
            value: false,
          },

          /**
           * The user Object.
           */
          user: {
            type: Object,
            value: {},
          },

          /**
           * The component theme.
           */
          theme: {
            type: String,
            value: 'light',
          },

          /**
           * The moment when the user sends the message.
           */
          time: {
            type: String,
            value: null,
            readOnly: true,
          },

          /**
           * The user is the message owner.
           */
          isOwner: {
            type: Boolean,
            value: false,
            readOnly: true,
          },

          /**
           * The user is the message owner.
           */
          showOriginal: {
            type: Boolean,
            value: false,
            readOnly: true,
          },

          /**
           * The message owner is anonymous
           */
          isAnonymous: {
            type: Boolean,
            value: true,
            readOnly: true,
          },

          /**
           * The message object
           */
          message: {
            type: Object,
            value: {},
            observer: '_messageChange',
          },

          /**
           * Text
           */
          text: {
            type: String,
            value: null,
            readOnly: true,
            notify: true,
          },

          /**
           * Original text
           */
          originalText: {
            type: String,
            value: null,
            readOnly: true,
            notify: true,
          },

          /**
           * User name acronym
           */
          acronym: {
            type: String,
            value: null,
            readOnly: true,
            notify: true,
          },

          /**
           * Image url
           */
          image: {
            type: String,
            value: null,
            readOnly: true,
            notify: true,
          },

          /**
           * Time pressed
           */
          timePressed: {
            type: Number,
            value: 0,
            readOnly: true,
            notify: true,
            observer: '_timePressedObserver',
          },

          /**
           *
           */
          timer: {
            type: Object,
            value: null,
            readOnly: true,
            notify: true,
          },

          /**
           * Icon
           */
          icon: {
            type: String,
            value: null,
            readOnly: true,
            computed: '_computeIcon(image, acronym)',
          },
        };
      }

      /**
       * @return {array}
       */
      static get observers() {
        return [
          '_checkBasics(signedIn, user.*, message)',
//          '_messageChange(message, message.*)',
        ];
      }

      /**
       * Check if is message basics
       *
       * @param {boolean} signedIn
       * @param {*} userData
       * @param {object} message
       * @return {boolean}
       * @private
       */
      _checkBasics(signedIn, userData, message) {
        // Set default values
        this._setIsOwner(false);
        this._setIsAnonymous(true);

        /**
         * Return if can't handle the basics
         */
        if (!message) {
          return false;
        }

        /**
         * Return if the message has no user
         */
        if (!message.uid) {
          return false;
        }
        /**
         * Check if is an anonymous user
         */
        this._setIsAnonymous(!!message.isAnonymous);

        /**
         * Check if the user is signed in
         */
        if (!signedIn) {
          return;
        }

        /**
         * Check if is the message owner
         */
        this._setIsOwner(this.user.uid === message.uid);
      }

      /**
       * Check message change
       *
       * @param {object} message
       * @private
       */
      _messageChange(message) {
        if (!message) return;
        this._setOriginalText(message.text);
        this._setText(message.text);

        if (message.text && message.locales) {
          this._returnFinalMessage(message.text, message.locales);
        }
        if (message.created) {
          this._setTime(message.created);
        } else {
          this._setTime(Date.now());
        }
        if (message.user) {
          this._messageUser(message.user);
        }
      }

      /**
       * User specific data
       *
       * @param {object} user
       * @private
       */
      _messageUser(user) {
        /**
         * Set Image
         */
        const image = user.avatar ? user.avatar : null;
        this._setImage(image);

        const name = user.name ? user.name : '';
        const acronym = name ? this._acronym(name) : null;
        this._setAcronym(acronym);
      }

      /**
       * Set final message text
       *
       * @param {string} text
       * @param {object} locales
       * @private
       */
      _returnFinalMessage(text, locales) {
        const language = this._getBrowserLanguage();
        let finalMessage = locales[language] ? locales[language] : text;
        this._setText(finalMessage);
      }

      /**
       * Return browser language
       *
       * @return {string}
       * @private
       */
      _getBrowserLanguage() {
        const language = (navigator.language || navigator.userLanguage) ?
          navigator.language : navigator.userLanguage;
        const separator = language.indexOf('-');
        return language.substring(0, separator !== -1 ? separator : language.length);
      }

      /**
       * Returns an acronym from string
       *
       * @param {string} text
       * @return {string}
       * @private
       */
      _acronym(text) {
        const matches = text.match(/\b(\w)/g);
        const finalMatches = matches.join('');
        return finalMatches.substring(0, 2);
      }

      /**
       * Bubble was pressed down
       *
       * @param {object} event
       * @private
       */
      _bubbleDown(event) {
        this._pressTimeOut();
      }

      /**
       * Bubble was released
       *
       * @param {object} event
       * @private
       */
      _bubbleUp(event) {
        window.clearInterval(this.timer);
        this._setTimePressed(0);
      }

      /**
       * The time that the the bubble has been pressed in seconds
       *
       * @param {number} time
       * @private
       */
      _timePressedObserver(time) {
        this._setShowOriginal(this.isOwner);
        if (time >= 1) {
          this._setShowOriginal(true);
        }
      }

      /**
       * Pressed time out
       *
       * @private
       */
      _pressTimeOut() {
        let time = 1;
        const timer = window.setInterval(() => {
          this._setTimePressed(time++);
        }, 1000);
        this._setTimer(timer);
      }

      /**
       * Compute icon
       *
       * @param {string} image
       * @param {string} acronym
       * @return {string}
       * @private
       */
       _computeIcon(image, acronym) {
        return !image && !acronym ? 'person' : null;
      }
    }

    window.customElements.define(SkeletonChatMessage.is, SkeletonChatMessage);
  </script>
</dom-module>
