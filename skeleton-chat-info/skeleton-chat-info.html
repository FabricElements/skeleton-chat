<link rel="import" href="../../polymer/polymer-element.html">
<link rel="import" href="../../polymerfire/firebase-auth.html">
<link rel="import" href="../../polymerfire/firebase-document.html">

<dom-module id="skeleton-chat-info">
  <template>
    <style>
      :host {
        display: none;
      }
    </style>
    <firebase-auth
      user="{{user}}">
    </firebase-auth>
    <firebase-document
      disabled$="[[!group]]"
      path$="/chats/groups/[[group]]"
      data="{{data}}">
    </firebase-document>
  </template>

  <script>
    /**
     * `skeleton-chat-info`
     *
     *
     * @license Copyright (c) 2017 FabricElements. All rights reserved.
     * @customElement
     * @polymer
     * @demo demo/index.html
     */
    class SkeletonChatInfo extends Polymer.Element {
      static get is() {
        return 'skeleton-chat-info';
      }

      static get properties() {
        return {
          /**
           * The user Object.
           */
          user: {
            type: Object,
            value: {},
          },

          /**
           * Group id
           */
          group: {
            type: String,
            value: null,
          },

          /**
           * Data object
           */
          data: {
            type: Object,
            value: {},
          },

          /**
           * Info data
           */
          info: {
            type: Object,
            notify: true,
            reflectToAttribute: true,
            readOnly: true,
            computed: '_computeInfo(data, user, data.*)',
          },
        };
      }

      /**
       *
       * @param {object} textObject
       * @return {null}
       * @private
       */
      _returnFinalText(textObject) {
        const language = this._getBrowserLanguage();
        const original = textObject.original ? textObject.original : null;
        return textObject[language] ? textObject[language] : original;
      }

      /**
       * Return browser language
       *
       * @return {string}
       * @private
       */
      _getBrowserLanguage() {
        const language = (navigator.language || navigator.userLanguage) ?
          navigator.language : navigator.userLanguage;
        const separator = language.indexOf('-');
        const finalLanguage = separator !== -1 ? separator : language.length;
        return language.substring(0, finalLanguage);
      }

      /**
       * Returns an acronym from string
       *
       * @param {string} text
       * @return {string}
       * @private
       */
      _acronym(text) {
        const matches = text.match(/\b(\w)/g);
        const finalMatches = matches.join('');
        return finalMatches.substring(0, 2);
      }

      /**
       * Compute the data and returns the info object
       *
       * @param {object} data
       * @param {object} user
       * @return {{}}
       * @private
       */
      _computeInfo(data, user) {
        let finalData = {};
        if (!data) return finalData;
        if (data.users) {
          const usersArray = this._usersToArray(data.users);
          finalData.users = usersArray;
          finalData.total = Object.keys(data.users).length;
          const objectUser = this._getObjectUsers(data.users, user);
          finalData.title = objectUser.name;
          finalData.image = objectUser.image;
        }

        if (data.info) {
          if (data.info.title) {
            finalData.title = this._returnFinalText(data.info.title);
          }
          if (data.info.description) {
            finalData.description = this._returnFinalText(data.info.description);
          }
          if (data.info.image) {
            finalData.image = data.info.image;
          }
        }

        return finalData;
      }

      /**
       * Extract first word from string
       *
       * @param {string} text
       * @return {string}
       * @private
       */
      _returnFistWord(text) {
        const i = text.indexOf(' ');
        return text.substring(0, i);
      }

      /**
       * Get object from users
       *
       * @param {object} users
       * @param {object} user
       * @return {*}
       * @private
       */
      _getObjectUsers(users, user) {
        let finalObject = {
          name: null,
          image: null,
        };

        if (!user || !user.uid) return finalObject;
        delete users[user.uid];

        let fullNames = [];
        let names = [];
        let person = {};
        for (let key in users) {
          if (users.hasOwnProperty(key)) {
            const userItem = users[key];
            // Set basic person
            person.name = userItem.name ? userItem.name : null;
            person.image = userItem.image ? userItem.image : null;
            // Set fullNames array
            if (userItem.name) {
              fullNames.push(userItem.name);
            }
            // Set names array
            const fistName = this._returnFistWord(userItem.name);
            names.push(fistName);
          }
        }

        if (fullNames.length <= 1) {
          finalObject.name = person.name;
          finalObject.image = person.image;
        } else {
          finalObject.name = names.join(', ');
          finalObject.image = null;
        }
        return finalObject;
      }

      /**
       * Return users array
       *
       * @param {object} users
       * @return {Array}
       * @private
       */
      _usersToArray(users) {
        return Object.keys(users).map((key) => {
          let user = users[key];
          if (user.name) {
            user.acronym = this._acronym(user.name);
          }
          user.uid = key;
          return users[key];
        });
      }
    }

    window.customElements.define(SkeletonChatInfo.is, SkeletonChatInfo);
  </script>
</dom-module>
