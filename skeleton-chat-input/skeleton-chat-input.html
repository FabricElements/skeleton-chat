<link rel="import" href="../../polymer/polymer-element.html">
<link rel="import" href="../../paper-input/paper-textarea.html">
<link rel="import" href="../../polymerfire/firebase-auth.html">
<link rel="import" href="../../polymerfire/firebase-firestore-script.html">
<link rel="import" href="../../paper-styles/shadow.html">
<link rel="import" href="../../paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../iron-icons/iron-icons.html">
<link rel="import" href="../../iron-icons/image-icons.html">
<link rel="import" href="../../iron-icons/av-icons.html">

<dom-module id="skeleton-chat-input">
  <template>
    <!--suppress CssInvalidPseudoSelector -->
    <!--suppress CssUnresolvedCustomProperty -->
    <!--suppress CssUnresolvedCustomPropertySet -->
    <style>
      :host {
        @apply --shadow-elevation-2dp;
        display: block;
        overflow-x: hidden;
        position: relative;
        margin: 1rem;
        /*width: 100%;*/
        box-sizing: border-box;
        /*border-top: 1px solid var(--skeleton-chat-input-border-color, var(--paper-grey-50));*/
        @apply --layout-inline;
        @apply --layout-horizontal;
        -ms-flex-wrap: nowrap;
        -webkit-flex-wrap: nowrap;
        border-radius: 28px;
        /*border: 1px solid red;*/
        @apply --skeleton-chat-input;

        /*-webkit-box-shadow: 0 -2px 3px -1px rgba(0, 0, 0, 0.14);*/
        /*box-shadow: 0 -1px 1px -2px rgba(0, 0, 0, 0.14),*/
        /*0 -2px 2px -2px rgba(0, 0, 0, 0.12),*/
        /*0 -3px 3px -2px rgba(0, 0, 0, 0.2);*/
        --skeleton-chat-input-container: {
          box-sizing: border-box;
        };
        /*Default reset*/
        --paper-input-container-underline: {
          display: none;
        };
        --paper-input-container-underline-focus: {
          display: none;
        };
        --paper-input-container: {
          padding: 0;
          @apply --skeleton-chat-input-container;
        };
        --paper-input-container-label: {
          /*padding: .5rem calc(40px + 0.5rem) .5rem .6rem;*/
          padding: 14px 10px;
        };
        --iron-autogrow-textarea: {
          box-sizing: border-box;
          padding: 14px 10px;
          word-break: break-all;
          min-height: 20px;
          max-height: 120px;
        };
        --paper-input-container-underline: {
          display: none;
        };
        --iron-autogrow-textarea-placeholder: {
          padding: 1rem;
          margin: 1rem;
          line-height: 56px;
        };
        --paper-icon-button: {
          border-radius: 50%;
          /*margin-left: 2px;*/
        };
        background-color: var(--skeleton-chat-input-bg, #ffffff);

        --no-select: {
          -webkit-user-select: none;
          -moz-user-select: none;
          -ms-user-select: none;
          user-select: none;
          -webkit-tap-highlight-color: rgba(0, 0, 0, 0);
        };
      }

      :host > * {
        @apply --no-select;
        @apply --layout-end-aligned;
      }

      :host([theme="dark"]) {
        /*border-top-color: var(--skeleton-chat-input-border-color-dark, var(--paper-grey-700));*/
        /*background-color: var(--skeleton-chat-bg-color-dark, var(--paper-grey-800));*/
        background-color: var(--skeleton-chat-input-bg, var(--paper-grey-900));
        --paper-input-container: {
          padding: 0;
          @apply --skeleton-chat-input-container;
        };
        --skeleton-chat-input-icon: {
          color: white;
        };
        --paper-input-container-input: {
          color: white;
        };
        --paper-input-container-color: var(--paper-grey-50);
      }

      :host > * {
        max-width: 100%;
      }

      [hide] {
        opacity: 0;
      }

      [hidden] {
        display: none;
      }

      #input {
        @apply --layout-flex-auto;
        box-sizing: border-box;
        position: relative;
        display: flex;
      }

      paper-textarea {
        box-sizing: border-box;
        @apply --layout-flex-none;
        width: 100%;
        max-width: 100%;
        @apply --skeleton-chat-input-input;
      }

      paper-icon-button {
        transition: all .3s ease-in-out;
        color: var(--paper-grey-800);
        margin: .5rem .5rem .5rem 0;
        width: 40px;
        height: 40px;
        flex-shrink: 0;
        flex-grow: 0;
        @apply --layout-self-end;
        @apply --skeleton-chat-input-icon;
      }

      .icon-emoji {
        @apply --skeleton-chat-input-icon-emoji;
      }

      .icon-camera {
        @apply --skeleton-chat-input-icon-camera;
      }

      .icon-mic,
      .icon-send {
        background-color: var(--skeleton-chat-input-action-bg, var(--accent-color));
        color: var(--skeleton-chat-input-action-color, #ffffff);
        --paper-icon-button: {
          padding: 5px;
          border-radius: 50%;
        };
      }

      .icon-mic {
        /*background-color: var(--paper-grey-800);*/
        /*color: white;*/
        @apply --skeleton-chat-input-icon-mic;
      }

      .icon-send {
        /*color: var(--accent-color);*/
        @apply --skeleton-chat-input-icon-send;
      }
    </style>

    <firebase-auth
      signed-in="{{signedIn}}"
      user="{{user}}">
    </firebase-auth>
    <div id="input">
      <paper-textarea label$="[[label]]"
                      value="{{text}}"
                      on-keydown="_checkForEnter"
                      no-label-float
                      max-rows="0"
                      maxlength$="[[maxlength]]">
      </paper-textarea>
    </div>
    <paper-icon-button icon="image:tag-faces"
                       class="icon-emoji"
                       hidden$="[[!emoji]]"
    ></paper-icon-button>
    <paper-icon-button icon="image:photo-camera"
                       class="icon-camera"
                       hidden$="[[!camera]]"
    ></paper-icon-button>
    <paper-icon-button icon="arrow-upward"
                       class="icon-send"
                       on-tap="_sendMessage"
                       hidden$="[[_showMic]]"
                       hide$="[[!text]]"
                       disabled$="[[!text]]"></paper-icon-button>
    <paper-icon-button icon="av:mic"
                       class="icon-mic"
                       hidden$="[[!_showMic]]"
    ></paper-icon-button>
  </template>

  <script>
    /**
     * `skeleton-chat-input`
     *
     * @license Copyright (c) 2017 FabricElements. All rights reserved.
     * @customElement
     * @polymer
     * @demo demo/index.html
     */
    class SkeletonChatInput extends Polymer.Element {
      /**
       * @return {string}
       */
      static get is() {
        return 'skeleton-chat-input';
      }

      /**
       * @return {object}
       */
      static get properties() {
        return {
          /**
           * A value to check if the user is signed in.
           */
          signedIn: {
            type: Boolean,
            value: false,
          },
          /**
           * The user Object.
           */
          user: {
            type: Object,
            value: {},
          },
          /**
           * The component theme.
           */
          theme: {
            type: String,
            value: 'light',
          },
          /**
           * The message to send
           */
          text: {
            type: String,
            value: null,
          },
          /**
           * The chat group.
           */
          group: {
            type: String,
            value: null,
          },
          /**
           * Displays emoji
           */
          emoji: {
            type: Boolean,
            value: false,
          },
          /**
           * Displays camera
           */
          camera: {
            type: Boolean,
            value: false,
          },
          /**
           * Displays microphone
           */
          mic: {
            type: Boolean,
            value: false,
          },
          /**
           * max length
           */
          maxlength: {
            type: Number,
          },
          /**
           * Chat input label
           */
          label: {
            type: String,
            value: 'Say something...',
          },
          /**
           * Show mic computed
           */
          _showMic: {
            type: Boolean,
            value: false,
            computed: '_computeShowMic(mic, text)',
          },
        };
      }

      /**
       * Function to send message on Enter key press.
       *
       * @param {object} event
       * @private
       */
      _checkForEnter(event) {
        // check if 'enter' was pressed
        if (event.keyCode === 13) {
          event.preventDefault();
          this._sendMessage();
        }
      }

      /**
       * Send message
       *
       * @return {*}
       * @private
       */
      _sendMessage() {
        if (!this.group) {
          return this._dispatchEvent('error', 'Define the group first.');
        }
        if (!this.user) {
          return this._dispatchEvent('error', 'You need to sign in first.');
        }
        if (!this.text) {
          return this._dispatchEvent('error', 'Empty message.');
        }

        const timestamp = firebase.firestore.FieldValue.serverTimestamp();
        /**
         * Format message
         */
        const message = {
          text: this.text,
          created: timestamp,
          updated: timestamp,
          user: {
            uid: this.user.uid,
            isAnonymous: this.user.isAnonymous,
            name: this.user.displayName ? this.user.displayName : null,
            image: this.user.photoURL ? this.user.photoURL : null,
          },
        };

        const baseText = this.text;
        this.text = null;
        const chatRef = `chat/${this.group}/messages`;
        const db = firebase.firestore();
        db.collection(chatRef).add(message)
          .then(() => {
            this._dispatchEvent('message', 'ok');
            this._updateGroupTimestamp();
          })
          .catch((err) => {
            this.text = baseText;
            console.error(err);
            this._dispatchEvent('error', err);
          });
      }

      /**
       * Dispatch event
       *
       * @param {string} event
       * @param  {string} detail
       * @private
       */
      _dispatchEvent(event, detail) {
        this.dispatchEvent(new CustomEvent(event, {
          detail: detail,
          bubbles: true,
          composed: true,
        }));
      }

      /**
       * Update timestamp
       *
       * @private
       */
      _updateGroupTimestamp() {
        const timestamp = firebase.firestore.FieldValue.serverTimestamp();
        const data = {
          updated: timestamp,
        };
        const db = firebase.firestore();
        db.collection('chat').doc(this.group).set(data, {merge: true})
          .then(() => {
//            console.log('updated');
          })
          .catch((err) => {
            console.error(err);
            this._dispatchEvent('error', err);
          });
      }

      /**
       * Show/hide mic
       *
       * @param {boolean} mic
       * @param {boolean} text
       * @return {boolean}
       * @private
       */
      _computeShowMic(mic, text) {
        return mic && !text;
      }
    }

    window.customElements.define(SkeletonChatInput.is, SkeletonChatInput);
  </script>
</dom-module>
